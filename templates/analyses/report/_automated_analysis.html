{% load analyses_tags %}

{# ============================================================= #}
{# AUTOMATED ANALYSIS OVERVIEW                                     #}
{# Structure: Verdict → Confidence Scores → Evidence Table →       #}
{#            Method Details (AI Detection, OpenCV Manipulation)    #}
{# No evidence is shown more than once on this page.              #}
{# ============================================================= #}

<!-- ==================== SECTION 1: VERDICT ==================== -->
{% if analysis.report.confidence %}
<div class="row-fluid">
    <div class="span12">
        <div class="alert {% if analysis.report.confidence.verdict == 'ai_generated' %}alert-error{% elif analysis.report.confidence.verdict == 'manipulated' %}alert-error{% elif analysis.report.confidence.verdict_certainty == 'inconclusive' %}alert-warning{% else %}alert-success{% endif %}" style="padding: 15px; margin-bottom: 20px;">
            <div class="row-fluid">
                <div class="span8">
                    <h3 style="margin: 0 0 5px 0;">
                        <i class="{% if analysis.report.confidence.verdict == 'authentic' and analysis.report.confidence.verdict_certainty != 'inconclusive' %}icon-ok-sign{% else %}icon-warning-sign{% endif %}"></i>
                        {{ analysis.report.confidence.verdict_label }}
                    </h3>
                    <p style="margin: 0;">
                        {% if analysis.report.confidence.verdict == 'ai_generated' %}
                            This image was identified as AI-generated.
                            {% if analysis.report.confidence.verdict_certainty == 'high' %}
                                Deterministic evidence confirms this with high confidence.
                            {% else %}
                                Probabilistic analysis suggests AI generation.
                            {% endif %}
                        {% elif analysis.report.confidence.verdict == 'manipulated' %}
                            Multiple forensic methods indicate this image has been manipulated.
                        {% elif analysis.report.confidence.verdict_certainty == 'inconclusive' %}
                            Analysis results are mixed. Some forensic methods raised concerns but evidence is not conclusive.
                        {% elif analysis.report.confidence.verdict_certainty == 'low' %}
                            Some forensic methods raised minor concerns. Review the evidence below.
                        {% else %}
                            Forensic analysis found no significant signs of manipulation or AI generation.
                        {% endif %}
                    </p>
                </div>
                <div class="span4" style="text-align: right; padding-top: 5px;">
                    <span style="font-size: 36px; font-weight: bold;">
                        {{ analysis.report.confidence.verdict_confidence|floatformat:0 }}%
                    </span>
                    <br><small class="muted">certainty in verdict</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ================ SECTION 2: CONFIDENCE SCORES ================ -->
<div class="row-fluid">
    <div class="span4">
        <div class="box">
            <div class="wdgt-header"><i class="icon-search"></i> Suspicion Score</div>
            <div class="wdgt-body">
                <div class="progress progress-striped {% if analysis.report.confidence.confidence_score > 70 %}progress-danger{% elif analysis.report.confidence.confidence_score > 50 %}progress-warning{% else %}progress-success{% endif %}"
                     style="height: 30px; margin-bottom: 5px;">
                    <div class="bar" style="width: {{ analysis.report.confidence.confidence_score|floatformat:0 }}%; line-height: 30px; font-size: 14px;">
                        {{ analysis.report.confidence.confidence_score|floatformat:0 }}%
                    </div>
                </div>
                <p class="muted" style="font-size: 11px; margin: 0;">How much evidence of manipulation was found. Higher = more suspicious.</p>
            </div>
        </div>
    </div>
    <div class="span4">
        <div class="box">
            <div class="wdgt-header"><i class="icon-bolt"></i> AI Generation Probability</div>
            <div class="wdgt-body">
                <div class="progress progress-striped {% if analysis.report.confidence.ai_generated_probability > 70 %}progress-danger{% elif analysis.report.confidence.ai_generated_probability > 50 %}progress-warning{% else %}progress-info{% endif %}"
                     style="height: 30px; margin-bottom: 5px;">
                    <div class="bar" style="width: {{ analysis.report.confidence.ai_generated_probability|floatformat:0 }}%; line-height: 30px; font-size: 14px;">
                        {{ analysis.report.confidence.ai_generated_probability|floatformat:0 }}%
                    </div>
                </div>
                <p class="muted" style="font-size: 11px; margin: 0;">Probability this image was generated by AI.</p>
            </div>
        </div>
    </div>
    <div class="span4">
        <div class="box">
            <div class="wdgt-header"><i class="icon-ok-circle"></i> Verdict Certainty</div>
            <div class="wdgt-body">
                <div class="progress progress-striped {% if analysis.report.confidence.verdict_confidence > 70 %}progress-success{% elif analysis.report.confidence.verdict_confidence > 40 %}progress-info{% else %}progress-warning{% endif %}"
                     style="height: 30px; margin-bottom: 5px;">
                    <div class="bar" style="width: {{ analysis.report.confidence.verdict_confidence|floatformat:0 }}%; line-height: 30px; font-size: 14px;">
                        {{ analysis.report.confidence.verdict_confidence|floatformat:0 }}%
                    </div>
                </div>
                <p class="muted" style="font-size: 11px; margin: 0;">How confident we are in the verdict above. Low = borderline case.</p>
            </div>
        </div>
    </div>
</div>

<!-- ================ SECTION 3: EVIDENCE TABLE ================ -->
{% if analysis.report.confidence.indicators %}
<div class="row-fluid" style="margin-top: 15px;">
    <div class="span12">
        <div class="box">
            <div class="wdgt-header">
                <i class="icon-list-alt"></i> Key Indicators
                <span class="pull-right">
                    <small class="muted">
                        <span class="label label-info" style="font-size: 9px;">Deterministic</span> = Rule-based |
                        <span class="label label-warning" style="font-size: 9px;">AI/ML</span> = Probabilistic
                    </small>
                </span>
            </div>
            <div class="wdgt-body">
                <table class="table table-condensed table-bordered table-striped" style="font-size: 12px; margin-bottom: 5px;">
                    <thead>
                        <tr>
                            <th style="width: 30%;">Method</th>
                            <th style="width: 10%;">Type</th>
                            <th>Evidence</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for indicator in analysis.report.confidence.indicators %}
                        <tr>
                            <td><strong>{{ indicator.method }}</strong></td>
                            <td>
                                {% if indicator.type == 'deterministic' %}
                                    <span class="label label-info" style="font-size: 9px;">Deterministic</span>
                                {% else %}
                                    <span class="label label-warning" style="font-size: 9px;">AI/ML</span>
                                {% endif %}
                            </td>
                            <td>{{ indicator.evidence }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <p class="muted" style="font-size: 10px; margin: 0;">
                    <strong>Note:</strong> Deterministic methods use mathematical analysis of image properties.
                    AI/ML methods use trained models and results are probabilistic.
                </p>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endif %}{# end confidence #}

<!-- ================ SECTION 4: METHOD DETAILS ================ -->
{# Each method is shown once with its full detail. #}

<!-- 4a: AI Generation Detection -->
{% if analysis.report.ai_detection %}
<div class="row-fluid" style="margin-top: 20px;">
    <div class="span12">
        <div class="box">
            <div class="wdgt-header">
                <i class="icon-bolt"></i> AI Generation Detection
                <span class="pull-right">
                    {% if analysis.report.ai_detection.error %}
                        <span class="label label-inverse">Unavailable</span>
                    {% elif not analysis.report.ai_detection.enabled %}
                        <span class="label">Disabled</span>
                    {% elif analysis.report.ai_detection.likely_ai %}
                        <span class="label label-important">AI Generated</span>
                    {% else %}
                        <span class="label label-success">Authentic</span>
                    {% endif %}
                </span>
            </div>
            <div class="wdgt-body">
                {% if analysis.report.ai_detection.error %}
                    <div class="alert alert-warning" style="margin-bottom: 0;">
                        <strong>Not Available:</strong> {{ analysis.report.ai_detection.error }}
                        <br><small>Run <code>make ai-setup</code> to enable AI detection.</small>
                    </div>
                {% elif analysis.report.ai_detection.enabled %}
                    {% if analysis.report.ai_detection.detection_layers %}
                    <table class="table table-condensed table-bordered" style="font-size: 12px; margin-bottom: 10px;">
                        <thead>
                            <tr>
                                <th style="width: 25%;">Detection Layer</th>
                                <th style="width: 12%;">Status</th>
                                <th style="width: 15%;">Confidence</th>
                                <th>Detail</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for layer in analysis.report.ai_detection.detection_layers %}
                            <tr>
                                <td><strong>{{ layer.method }}</strong></td>
                                <td>
                                    {% if layer.verdict == 'Unknown' %}
                                        <span class="label">N/A</span>
                                    {% elif layer.verdict == 'AI' %}
                                        <span class="label label-important">FAIL</span>
                                    {% else %}
                                        <span class="label label-success">PASS</span>
                                    {% endif %}
                                </td>
                                <td>{{ layer.confidence|upper }}</td>
                                <td class="muted">{{ layer.evidence|default:"No data available" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% endif %}

                    {% if analysis.report.ai_detection.detection_framework %}
                        <p class="muted" style="font-size: 10px; margin: 0;">
                            <strong>Framework:</strong> {{ analysis.report.ai_detection.detection_framework }}
                            &nbsp;|&nbsp;
                            <strong>Overall AI Probability:</strong> {{ analysis.report.ai_detection.ai_probability|floatformat:1 }}%
                            &nbsp;|&nbsp;
                            <strong>Confidence:</strong>
                            <span class="label {% if analysis.report.ai_detection.confidence == 'certain' or analysis.report.ai_detection.confidence == 'high' %}label-important{% elif analysis.report.ai_detection.confidence == 'medium' %}label-warning{% else %}label-info{% endif %}" style="font-size: 9px;">
                                {{ analysis.report.ai_detection.confidence|upper }}
                            </span>
                        </p>
                    {% endif %}
                {% else %}
                    <p class="muted" style="margin-bottom: 0;">AI detection not configured. Run <code>make ai-setup</code> to install.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 4b: OpenCV Manipulation Detection -->
{% if analysis.report.opencv_manipulation %}
<div class="row-fluid" style="margin-top: 15px;">
    <div class="span12">
        <div class="box">
            <div class="wdgt-header">
                <i class="icon-search"></i> Image Manipulation Detection
                <span class="pull-right">
                    {% if analysis.report.opencv_manipulation.error %}
                        <span class="label label-inverse">Unavailable</span>
                    {% elif not analysis.report.opencv_manipulation.enabled %}
                        <span class="label">Disabled</span>
                    {% elif analysis.report.opencv_manipulation.is_suspicious %}
                        <span class="label label-warning">Suspicious</span>
                    {% else %}
                        <span class="label label-success">No Issues</span>
                    {% endif %}
                </span>
            </div>
            <div class="wdgt-body">
                {% if analysis.report.opencv_manipulation.error %}
                    <div class="alert alert-warning" style="margin-bottom: 0;">
                        <strong>Not Available:</strong> {{ analysis.report.opencv_manipulation.error }}
                        <br><small>Run <code>make opencv-start</code> to enable manipulation detection.</small>
                    </div>
                {% elif analysis.report.opencv_manipulation.enabled %}
                    <table class="table table-condensed table-bordered" style="font-size: 12px; margin-bottom: 10px;">
                        <thead>
                            <tr>
                                <th style="width: 25%;">Method</th>
                                <th style="width: 12%;">Status</th>
                                <th style="width: 15%;">Confidence</th>
                                <th>Detail</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if analysis.report.opencv_manipulation.manipulation_detection %}
                            <tr>
                                <td><strong><i class="icon-eye-open"></i> Gaussian Blur</strong></td>
                                <td>
                                    {% if analysis.report.opencv_manipulation.manipulation_detection.is_manipulated %}
                                        <span class="label label-warning">Detected</span>
                                    {% else %}
                                        <span class="label label-success">Clean</span>
                                    {% endif %}
                                </td>
                                <td>{{ analysis.report.opencv_manipulation.manipulation_detection.confidence|pct:1 }}%</td>
                                <td class="muted">
                                    {{ analysis.report.opencv_manipulation.manipulation_detection.evidence }}
                                    <small>({{ analysis.report.opencv_manipulation.manipulation_detection.num_anomalies }} anomalies, {{ analysis.report.opencv_manipulation.manipulation_detection.anomaly_percentage|floatformat:1 }}% coverage)</small>
                                </td>
                            </tr>
                            {% endif %}
                            {% if analysis.report.opencv_manipulation.noise_analysis %}
                            <tr>
                                <td><strong><i class="icon-signal"></i> Noise Consistency</strong></td>
                                <td>
                                    {% if analysis.report.opencv_manipulation.noise_analysis.is_noise_inconsistent %}
                                        <span class="label label-warning">Inconsistent</span>
                                    {% else %}
                                        <span class="label label-success">Consistent</span>
                                    {% endif %}
                                </td>
                                <td>{{ analysis.report.opencv_manipulation.noise_analysis.noise_consistency|pct:1 }}%</td>
                                <td class="muted">
                                    Overall noise: {{ analysis.report.opencv_manipulation.noise_analysis.overall_noise|floatformat:2 }},
                                    variation: {{ analysis.report.opencv_manipulation.noise_analysis.coefficient_variation|floatformat:3 }}
                                    {% if analysis.report.opencv_manipulation.noise_analysis.quadrant_variances %}
                                        <small>(Quadrants: {% for var in analysis.report.opencv_manipulation.noise_analysis.quadrant_variances %}Q{{ forloop.counter }}:{{ var|floatformat:1 }}{% if not forloop.last %}, {% endif %}{% endfor %})</small>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endif %}
                            {% if analysis.report.opencv_manipulation.jpeg_artifacts %}
                            <tr>
                                <td><strong><i class="icon-file-alt"></i> JPEG Artifacts</strong></td>
                                <td>
                                    {% if analysis.report.opencv_manipulation.jpeg_artifacts.has_inconsistent_artifacts %}
                                        <span class="label label-warning">Inconsistent</span>
                                    {% else %}
                                        <span class="label label-success">Consistent</span>
                                    {% endif %}
                                </td>
                                <td>{{ analysis.report.opencv_manipulation.jpeg_artifacts.confidence|pct:1 }}%</td>
                                <td class="muted">
                                    {{ analysis.report.opencv_manipulation.jpeg_artifacts.evidence }}
                                    <small>(compression variation: {{ analysis.report.opencv_manipulation.jpeg_artifacts.compression_variation|floatformat:3 }})</small>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>

                    <p class="muted" style="font-size: 10px; margin: 0;">
                        <strong>Overall:</strong> {{ analysis.report.opencv_manipulation.overall_confidence|pct:1 }}% confidence
                        — {{ analysis.report.opencv_manipulation.interpretation }}
                        &nbsp;|&nbsp;
                        <strong>Service:</strong> {{ analysis.report.opencv_manipulation.service }}
                    </p>
                {% else %}
                    <p class="muted" style="margin-bottom: 0;">Manipulation detection not configured. Run <code>make opencv-start</code> to enable.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- ================ FALLBACK: NOTHING AVAILABLE ================ -->
{% if not analysis.report.ai_detection and not analysis.report.opencv_manipulation and not analysis.report.confidence %}
<div class="row-fluid">
    <div class="span12">
        <div class="alert alert-info">
            <h4>No Automated Analysis Available</h4>
            <p>Neither AI detection nor manipulation detection are currently configured.</p>
            <p>
                <strong>To enable:</strong><br>
                &bull; AI Detection: <code>make ai-setup</code><br>
                &bull; Manipulation Detection: <code>make opencv-start</code>
            </p>
        </div>
    </div>
</div>
{% endif %}
