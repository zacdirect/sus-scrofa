{% extends "analyses/report/report_base.html" %}

{% block report_content %}

<div class="container-fluid px-0">
    <div class="alert alert-info mb-4">
        <i class="fa-solid fa-flask me-2"></i> <strong>Experimental Features</strong>
        <br>
        This section contains advanced research findings including photorealism detection, object recognition, and person attribute analysis.
    </div>

    {# ======== SECTION 1: Photorealism ======== #}
    {% if content.photorealism %}
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white py-3">
             <h5 class="card-title mb-0"><i class="fa-solid fa-camera me-2 text-primary"></i> Photorealism Classification</h5>
        </div>
        <div class="card-body">
            {% with photo=content.photorealism %}
            <div class="row g-4">
                <div class="col-md-6">
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <th scope="row">Classification</th>
                                <td>
                                    {% if photo.is_photorealistic %}
                                        <span class="badge bg-success">Photorealistic</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">Non-Photorealistic</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">Composite Score</th>
                                <td>{{ photo.composite_score }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Confidence</th>
                                <td>{{ photo.confidence }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="col-md-6">
                    {% if photo.signals %}
                    <h6 class="text-muted mb-3">Signal Breakdown</h6>
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Signal</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for key, val in photo.signals.items %}
                            <tr>
                                <td>{{ key }}</td>
                                <td>{{ val }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% endif %}
                </div>
            </div>
            {% endwith %}
        </div>
    </div>
    {% endif %}

    {# ======== SECTION 2: Object Detection ======== #}
    {% if content.objects %}
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white py-3 d-flex align-items-center">
            <h5 class="card-title mb-0 me-3"><i class="fa-solid fa-eye me-2 text-info"></i> Object Detection</h5>
            {% if content.objects.total_detections %}
                <span class="badge bg-info text-dark rounded-pill">{{ content.objects.total_detections }} detected</span>
            {% endif %}
        </div>
        <div class="card-body">
            {% if content.objects.class_counts %}
            <div class="table-responsive">
                <table class="table table-sm table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Object Class</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cls, count in content.objects.class_counts.items %}
                        <tr>
                            <td>{{ cls }}</td>
                            <td><span class="badge bg-secondary">{{ count }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted mb-0">No objects detected.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {# ======== SECTION 3: Person Analysis ======== #}
    {% if content.persons %}
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white py-3 d-flex align-items-center flex-wrap">
            <h5 class="card-title mb-0 me-3"><i class="fa-solid fa-user me-2 text-success"></i> Person Analysis</h5>
            <span class="badge bg-info text-dark me-2">{{ content.persons|length }} person{{ content.persons|length|pluralize }}</span>
            {% if content.yunet_faces %}
                <span class="badge bg-secondary">{{ content.yunet_faces }} YuNet face{{ content.yunet_faces|pluralize }}</span>
            {% endif %}
        </div>
        <div class="card-body">
            {% for person in content.persons %}
            <div class="card bg-light border-0 mb-3">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        Person {{ forloop.counter }}
                        {% if person.detection_confidence %}
                            <small class="text-muted fs-6 ms-2">(confidence: {{ person.detection_confidence }})</small>
                        {% endif %}
                        {% if person.too_small %}
                            <span class="badge bg-secondary ms-2">Too small to analyse</span>
                        {% endif %}
                    </h5>

                    {% if not person.too_small %}
                    <div class="row g-3">
                        {# -- Hair -- #}
                        <div class="col-md-4">
                            <h6 class="text-primary"><i class="fa-solid fa-tint me-1"></i> Hair</h6>
                            <div class="ps-3 border-start border-2 border-primary">
                            {% with hair=person.hair_color %}
                            {% if hair %}
                                {% if hair.color and hair.color != "unknown" and hair.color != "?" %}
                                    <span class="badge bg-info text-dark">{{ hair.color }}</span>
                                    {% if hair.confidence %}
                                        <small class="text-muted ms-1">({{ hair.confidence }})</small>
                                    {% endif %}
                                {% elif hair.reason %}
                                    <span class="text-muted">{{ hair.reason }}</span>
                                {% else %}
                                    <span class="text-muted">Unknown</span>
                                {% endif %}
                            {% endif %}
                            {% endwith %}
                            </div>
                        </div>

                        {# -- Tattoos -- #}
                        <div class="col-md-4">
                            <h6 class="text-warning"><i class="fa-solid fa-star me-1"></i> Tattoos</h6>
                            <div class="ps-3 border-start border-2 border-warning">
                            {% with tat=person.tattoo_analysis %}
                            {% if tat.detected_regions %}
                                {% for region in tat.detected_regions %}
                                    <span class="badge bg-warning text-dark">{{ region }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">None detected</span>
                            {% endif %}
                            {% endwith %}
                            </div>
                        </div>

                        {# -- Piercings -- #}
                        <div class="col-md-4">
                            <h6 class="text-danger"><i class="fa-regular fa-circle me-1"></i> Piercings</h6>
                             <div class="ps-3 border-start border-2 border-danger">
                            {% with pier=person.piercing_analysis %}
                            {% if pier.piercings %}
                                {% for p in pier.piercings %}
                                    <span class="badge bg-danger">{{ p }}</span>
                                {% endfor %}
                                {% if pier.inter_eye_dist %}
                                    <div class="small text-muted mt-1">inter-eye dist: {{ pier.inter_eye_dist }}</div>
                                {% endif %}
                            {% elif pier.note %}
                                <span class="text-muted">Skipped ({{ pier.note }})</span>
                            {% else %}
                                <span class="text-muted">None detected</span>
                            {% endif %}
                            {% endwith %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {# ======== SECTION 4: Annotated Image ======== #}
    {% if content.annotation_gridfs_id %}
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white py-3">
             <h5 class="card-title mb-0"><i class="fa-solid fa-image me-2 text-secondary"></i> Annotated Image</h5>
        </div>
        <div class="card-body text-center">
            <p class="text-muted mb-3">
                Overlay showing detected persons (green), keypoints (cyan), YuNet faces (magenta),
                piercings (red), tattoos (orange), and hair regions (blue).
            </p>
            <a href="{% url "research_annotation" analysis.id %}" class="fancybox d-inline-block shadow-sm rounded glightbox">
                <img src="{% url "research_annotation" analysis.id %}"
                     class="img-fluid rounded border"
                     style="max-height: 600px;"
                     alt="Annotated research image">
            </a>
        </div>
    </div>
    {% endif %}

    {# ======== SECTION 5: Audit Findings ======== #}
    {% if content.audit_findings %}
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white py-3">
            <h5 class="card-title mb-0"><i class="fa-solid fa-list-check me-2 text-warning"></i> Research Audit Findings</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Level</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th>Direction</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for finding in content.audit_findings %}
                        <tr>
                            <td>
                                {% if finding.level == "HIGH" %}
                                    <span class="badge bg-danger">{{ finding.level }}</span>
                                {% elif finding.level == "MEDIUM" %}
                                    <span class="badge bg-warning text-dark">{{ finding.level }}</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ finding.level }}</span>
                                {% endif %}
                            </td>
                            <td>{{ finding.category }}</td>
                            <td>{{ finding.description }}</td>
                            <td>
                                {% if finding.positive %}
                                    <span class="text-success fw-bold"><i class="fa-solid fa-plus-circle me-1"></i> Genuine</span>
                                {% else %}
                                    <span class="text-danger fw-bold"><i class="fa-solid fa-minus-circle me-1"></i> Suspicious</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    {# ======== SECTION 6: Image Metadata ======== #}
    {% if content.image_size %}
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white py-3">
             <h5 class="card-title mb-0"><i class="fa-solid fa-info-circle me-2 text-muted"></i> Image Info</h5>
        </div>
        <div class="card-body">
            <table class="table table-sm" style="width: auto;">
                <tbody>
                    <tr>
                         <th scope="row" class="pe-4">Dimensions</th>
                        <td>{{ content.image_size.width }} Ã— {{ content.image_size.height }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
