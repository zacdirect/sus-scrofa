{% load analyses_tags %}

<div id="map_canvas" style="height: 600px;"></div>

<script type="text/javascript">
$(document).ready(function(){
    initializeCaseMap();
});

function initializeCaseMap() {
    // Initialize Leaflet map with OpenStreetMap
    var map = L.map('map_canvas').setView([0, 0], 2);
    
    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);

    {% for image in images %}
        var contentString_{{ forloop.counter }} = '<div><a href="{% url "show_analysis" image.id %}"><h4>{% if image.file_name|length > 20 %}{{ image.file_name|slice:":20" }} ...{% else %}{{ image.file_name }}{% endif %}</h4><img src="{% url "image" image.thumb_id %}" style="max-width:200px;"/><div class="tags">{% if image.report.signatures|count_severity:"1" %}<span class="label-holder"><span class="label label-success">{{ image.report.signatures|count_severity:"1" }}</span></span>{% endif %}{% if image.report.signatures|count_severity:"2" %}<span class="label-holder"><span class="label label-warning">{{ image.report.signatures|count_severity:"2" }}</span></span>{% endif %}{% if image.report.signatures|count_severity:"3" %}<span class="label-holder"><span class="label label-important">{{ image.report.signatures|count_severity:"3" }}</span></span>{% endif %}</div></a></div>';
        
        var marker_{{ forloop.counter }} = L.marker([{{ image.latitude|floatformat:6 }}, {{ image.longitude|floatformat:6 }}])
            .addTo(map)
            .bindPopup(contentString_{{ forloop.counter }});
    {% endfor %}
    
    // Fit map to show all markers if there are any
    {% if images %}
    var markers = [
        {% for image in images %}
        [{{ image.latitude|floatformat:6 }}, {{ image.longitude|floatformat:6 }}]{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    if (markers.length > 0) {
        var bounds = L.latLngBounds(markers);
        map.fitBounds(bounds, {padding: [50, 50]});
    }
    {% endif %}
}
</script>